# Инструкция по анализу файла статистики звонков Verto

## Структура файла статистики

Файл статистики звонков Verto (`verto_calls_*.json`) содержит три основных массива данных:

1. `verto` - массив с информацией о звонках
2. `cause` - массив с причинами завершения звонков
3. `lastCalls` - массив с детальной статистикой последних звонков

### Анализ массива verto
- Содержит основную информацию о каждом звонке
- Включает идентификаторы, временные метки, участников звонка
- Позволяет отслеживать общую статистику звонков

### Анализ массива cause
- Содержит причины завершения звонков
- Позволяет анализировать паттерны завершения звонков
- Помогает выявлять системные проблемы

### Анализ массива lastCalls
- Содержит детальную статистику по каждому звонку
- Включает информацию о:
  * ICE кандидатах
  * RTP потоках (входящих и исходящих)
  * Статистике медиа
  * Логах звонка

## Подробный анализ параметров inbound-rtp

### 1. Основные параметры идентификации
- `type: "inbound-rtp"` - тип статистики (входящий RTP поток)
- `timestamp` - временная метка сбора статистики
- `codecId` - идентификатор используемого кодека
- `kind` и `mediaType` - тип медиа (аудио/видео)
- `ssrc` - идентификатор потока RTP
- `transportId` - идентификатор транспортного соединения

### 2. Параметры качества сети
- `jitter` - колебание задержки между пакетами
  * Норма: 0-30 мс
  * >30 мс может вызывать проблемы со звуком
  
- `packetsLost` - количество потерянных пакетов
  * Норма: 0-1%
  * >1% может вызывать заметные проблемы с качеством

- `packetsReceived` - количество полученных пакетов
  * Используется для расчета % потерь: (packetsLost / packetsReceived) * 100%

### 3. Параметры аудио качества
- `audioLevel` - уровень громкости звука
  * Норма: >0.001
  * Слишком низкие значения могут указывать на проблемы с микрофоном

- `totalAudioEnergy` - общая энергия звука
  * Помогает определить периоды активной речи

### 4. Параметры буферизации
- `jitterBufferDelay` - задержка джиттер-буфера
- `jitterBufferMinimumDelay` - минимальная задержка буфера
- `jitterBufferTargetDelay` - целевая задержка буфера
  * Эти параметры помогают оценить настройки буферизации
  * Большая разница между значениями может указывать на проблемы с сетью

### 5. Параметры маскирования потерь
- `concealedSamples` - количество замаскированных сэмплов
- `concealmentEvents` - количество событий маскирования
- `silentConcealedSamples` - количество тихих замаскированных сэмплов
  * Высокие значения указывают на проблемы с сетью
  * Норма: <1% от общего количества сэмплов

### 6. Параметры коррекции темпа
- `insertedSamplesForDeceleration` - вставленные сэмплы для замедления
- `removedSamplesForAcceleration` - удаленные сэмплы для ускорения
  * Показывают работу алгоритма синхронизации
  * Большие значения могут указывать на проблемы синхронизации

### 7. Параметры объема данных
- `bytesReceived` - полученные байты данных
- `headerBytesReceived` - полученные байты заголовков
  * Помогают оценить нагрузку на сеть

### 8. Временные параметры
- `lastPacketReceivedTimestamp` - время получения последнего пакета
- `totalSamplesDuration` - общая длительность сэмплов
- `totalProcessingDelay` - общая задержка обработки

### 9. Параметры обработки пакетов
- `packetsDiscarded` - отброшенные пакеты
- `fecPacketsDiscarded` - отброшенные FEC пакеты
- `fecPacketsReceived` - полученные FEC пакеты

## Подробный анализ параметров outbound-rtp

### 1. Основные параметры идентификации
- `type: "outbound-rtp"` - тип статистики (исходящий RTP поток)
- `timestamp` - временная метка сбора статистики
- `codecId` - идентификатор используемого кодека
- `kind` и `mediaType` - тип медиа (аудио/видео)
- `ssrc` - идентификатор потока RTP
- `transportId` - идентификатор транспортного соединения

### 2. Параметры качества сети
- `jitter` - колебание задержки между пакетами
  * Норма: 0-30 мс
  * >30 мс может вызывать проблемы со звуком
  
- `packetsLost` - количество потерянных пакетов
  * Норма: 0-1%
  * >1% может вызывать заметные проблемы с качеством

- `packetsSent` - количество отправленных пакетов
  * Используется для расчета % потерь: (packetsLost / packetsSent) * 100%

### 3. Параметры аудио качества
- `audioLevel` - уровень громкости звука
  * Норма: >0.001
  * Слишком низкие значения могут указывать на проблемы с микрофоном

- `totalAudioEnergy` - общая энергия звука
  * Помогает определить периоды активной речи

### 4. Параметры объема данных
- `bytesSent` - отправленные байты данных
- `headerBytesSent` - отправленные байты заголовков
  * Помогают оценить нагрузку на сеть

### 5. Временные параметры
- `lastPacketSentTimestamp` - время отправки последнего пакета
- `totalSamplesDuration` - общая длительность сэмплов
- `totalProcessingDelay` - общая задержка обработки

### 6. Параметры обработки пакетов
- `packetsDiscarded` - отброшенные пакеты
- `fecPacketsDiscarded` - отброшенные FEC пакеты
- `fecPacketsSent` - отправленные FEC пакеты

## Анализ ICE кандидатов

### 1. Основные параметры
- `candidateType` - тип кандидата (host, srflx, relay)
- `ip` - IP-адрес кандидата
- `port` - порт кандидата
- `protocol` - протокол (udp/tcp)
- `priority` - приоритет кандидата

### 2. Параметры качества
- `rtt` - время отклика
  * Норма: <100 мс
  * >200 мс может вызывать проблемы с качеством

- `availableOutgoingBitrate` - доступная исходящая пропускная способность
- `availableIncomingBitrate` - доступная входящая пропускная способность

### 3. Параметры состояния
- `state` - состояние кандидата (frozen, waiting, in-progress, succeeded, failed)
- `selected` - выбран ли кандидат для использования
- `deleted` - удален ли кандидат

### 4. Анализ типа соединения
- Необходимо проверять параметр `networkType` для выбранной пары кандидатов
- Особое внимание уделять случаям использования WiFi (`networkType: "wifi"`)
- WiFi соединение может быть причиной нестабильности связи
- Рекомендуется сигнализировать при обнаружении WiFi соединения, так как это может объяснять проблемы с качеством связи
- Для WiFi соединений рекомендуется:
  * Проверять уровень сигнала
  * Анализировать загруженность канала
  * Рассматривать возможность перехода на проводное соединение
  * Мониторить стабильность соединения более внимательно

## Пороговые значения для оценки качества

### Отличное качество:
- Потери пакетов < 0.1%
- Джиттер < 10 мс
- Маскирование < 0.1%
- RTT < 50 мс

### Хорошее качество:
- Потери пакетов < 0.5%
- Джиттер < 20 мс
- Маскирование < 0.5%
- RTT < 100 мс

### Удовлетворительное качество:
- Потери пакетов < 1%
- Джиттер < 30 мс
- Маскирование < 1%
- RTT < 200 мс

### Плохое качество:
- Потери пакетов > 1%
- Джиттер > 30 мс
- Маскирование > 1%
- RTT > 200 мс

## Формулы расчета ключевых показателей
```
Потери пакетов (входящие) = (packetsLost / packetsReceived) * 100%
Потери пакетов (исходящие) = (packetsLost / packetsSent) * 100%
Процент маскирования = (concealedSamples / totalSamplesReceived) * 100%
```

## Анализ массива cause (расширенный)

### 1. Основные параметры записи
- `callId` - идентификатор звонка
- `caller_id_number` - номер звонящего
- `mynumber` - собственный номер агента
- `cause` - причина завершения звонка
- `causeCode` - код причины завершения
- `reason` - дополнительное описание причины
- `causeDateTime` - дата и время события в формате локали с временной зоной

### 2. Параметры статуса агента (agentStatus)
- `currentStatus` - текущий статус агента
  * `id` - идентификатор статуса
  * `name` - название статуса на языке интерфейса
- `previousStatus` - предыдущий статус агента
  * `id` - идентификатор статуса
  * `name` - название статуса на языке интерфейса
- `isChanging` - флаг процесса изменения статуса
- `checkAfterUpdate` - флаг необходимости проверки после обновления

### 3. Параметры постобработки (postprocess)
- `lastPostprocessingStatus` - последний статус постобработки
  * `id` - идентификатор статуса
  * `name` - название статуса на языке интерфейса
- `wrapUpTime` - установленное время постобработки (в секундах)
- `timer` - информация о таймере постобработки
  * `dt_start` - дата и время начала постобработки
  * `currentTimer` - текущее значение таймера
  * `timer` - статус работы таймера
- `statusOnOutcallPostprocessing` - статус постобработки для исходящих вызовов
- `statusOnCCInbcallPostprocessing` - статус постобработки для входящих вызовов из очереди
- `statusOnDirectInbcallPostprocessing` - статус постобработки для прямых входящих вызовов

### Анализ параметров постобработки

#### 1. Оценка эффективности постобработки
- Сравнение `wrapUpTime` с фактическим временем постобработки
- Анализ частоты прерывания постобработки
- Выявление паттернов использования разных статусов постобработки

#### 2. Мониторинг статусов
- Отслеживание последовательности смены статусов
- Анализ времени нахождения в каждом статусе
- Выявление нетипичных переходов между статусами

#### 3. Контроль таймеров
- Проверка корректности работы таймеров
- Анализ случаев преждевременного завершения
- Выявление проблем с синхронизацией

### Рекомендации по анализу расширенных данных

1. Построение цепочек событий:
```
Звонок -> Изменение статуса -> Постобработка -> Возврат к исходному статусу
```

2. Выявление проблемных паттернов:
- Частые прерывания постобработки
- Нетипичные последовательности статусов
- Отклонения от установленного времени постобработки

3. Метрики для анализа:
```
Эффективность постобработки = (фактическое время / wrapUpTime) * 100%
Частота прерываний = (количество прерванных постобработок / общее количество) * 100%
Среднее время в статусе = сумма времени в статусе / количество переходов в статус
```

4. Критерии качества процессов:
- Соблюдение времени постобработки: отклонение не более 10%
- Частота прерываний: не более 5%
- Корректность последовательности статусов: 95% соответствие установленным правилам

## Рекомендации по анализу
1. Сопоставление всех метрик для выявления корреляций
2. Определение первопричины проблем с качеством
3. Мониторинг трендов изменения параметров во времени
4. Анализ влияния сетевых условий на качество связи
5. Оценка эффективности механизмов маскирования потерь
6. Анализ выбора ICE кандидатов и их эффективности
7. Мониторинг состояния сетевых соединений
8. Оценка эффективности буферизации и обработки пакетов 